#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLE2902.h>

#define THERMISTOR_PIN 4
BLECharacteristic* pC1 = NULL;
bool deviceConnected = false;

// UUIDは100が出た時と同じものを使います
#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "f4deb353-a4cf-4ffb-badb-2a5f2e3bb630"

class MyCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* p) { deviceConnected = true; }
    void onDisconnect(BLEServer* p) { deviceConnected = false; }
};

void setup() {
  Serial.begin(9600);
  pinMode(THERMISTOR_PIN, INPUT);

  // 名前を「v2」に変えてiPadの記憶をリセットさせます
  BLEDevice::init("kfac-v2"); 
  BLEServer *pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyCallbacks());
  BLEService *pService = pServer->createService(SERVICE_UUID);

  // 入り口（Characteristic）は1つだけに絞ります
  pC1 = pService->createCharacteristic(CHARACTERISTIC_UUID, BLECharacteristic::PROPERTY_NOTIFY | BLECharacteristic::PROPERTY_READ);
  pC1->addDescriptor(new BLE2902());

  pService->start();
  BLEAdvertising *pAdv = BLEDevice::getAdvertising();
  pAdv->addServiceUUID(SERVICE_UUID);
  pAdv->setScanResponse(true);
  pAdv->setMinPreferred(0x06);
  pAdv->setMaxPreferred(0x12);
  BLEDevice::startAdvertising();
}

void loop() {
  static unsigned long last = 0;
  if (deviceConnected && (millis() - last > 500)) {
    // データパック作成 [RPM低, RPM高, 温度] の3バイト
    uint16_t hz = 100;
    int rawTemp = analogRead(THERMISTOR_PIN);
    uint8_t t = (uint8_t)(rawTemp / 16); // 簡易的な温度代わり

    uint8_t data[3];
    data[0] = hz & 0xFF;
    data[1] = (hz >> 8) & 0xFF;
    data[2] = t;

    pC1->setValue(data, 3);
    pC1->notify();

    Serial.printf("Sent Hz: %d, Raw/16: %d\n", hz, t);
    last = millis();
  }
  if (!deviceConnected) { delay(100); BLEDevice::startAdvertising(); }
}
